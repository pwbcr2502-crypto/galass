# 数据库数据交接说明

## 📊 当前数据状态

**数据统计** (截至 2025-08-12):
- **活动数量**: 3个
- **员工数据**: 10位员工
- **节目数据**: 19个节目
- **投票记录**: 4条投票
- **统计缓存**: 40条统计记录
- **Redis缓存**: 0条记录

## 🔄 数据交接方式

### 1. 完整数据库备份 (推荐)

已生成完整备份文件: `handover/database_full_backup_YYYYMMDD_HHMMSS.sql`

**新系统恢复方法**:
```bash
# 启动新环境
./scripts/start.sh

# 恢复数据
docker exec -i galass-postgres psql -U postgres -d anniversary_voting < handover/database_full_backup_YYYYMMDD_HHMMSS.sql
```

### 2. Docker数据卷直接拷贝 (最快)

**拷贝持久化数据**:
```bash
# 停止当前系统
./scripts/stop.sh

# 拷贝数据卷内容到新环境
docker run --rm -v galass_postgres_data:/source -v $(pwd)/handover:/backup alpine tar czf /backup/postgres_data.tar.gz -C /source .
docker run --rm -v galass_redis_data:/source -v $(pwd)/handover:/backup alpine tar czf /backup/redis_data.tar.gz -C /source .
```

**新环境恢复**:
```bash
# 在新环境创建相同的数据卷
docker volume create galass_postgres_data
docker volume create galass_redis_data

# 恢复数据
docker run --rm -v galass_postgres_data:/target -v $(pwd)/handover:/backup alpine tar xzf /backup/postgres_data.tar.gz -C /target
docker run --rm -v galass_redis_data:/target -v $(pwd)/handover:/backup alpine tar xzf /backup/redis_data.tar.gz -C /target
```

### 3. 目录拷贝 (最简单)

**直接拷贝数据目录**:
```bash
# 拷贝整个数据目录
cp -r ./data/ ./handover/data_backup/
```

**新环境使用**:
```bash
# 拷贝到新环境项目根目录
cp -r handover/data_backup/ ./data/

# 启动系统
./scripts/start.sh
```

## ⚡ 快速交接步骤

1. **打包当前环境**:
   ```bash
   # 创建交接包
   tar czf galass_handover_$(date +%Y%m%d).tar.gz \
     handover/ data/ logs/ .env docker-compose*.yml scripts/
   ```

2. **给新开发者的文件**:
   - `galass_handover_YYYYMMDD.tar.gz` - 完整交接包
   - `handover/database_full_backup_YYYYMMDD_HHMMSS.sql` - 数据库备份
   - 项目源代码
   - 环境配置文件

3. **新环境启动验证**:
   ```bash
   # 解压交接包
   tar xzf galass_handover_YYYYMMDD.tar.gz
   
   # 启动系统
   ./scripts/start.sh
   
   # 验证数据
   docker exec galass-postgres psql -U postgres -d anniversary_voting -c "SELECT COUNT(*) FROM votes;"
   ```

## 🔍 数据验证

**关键数据检查**:
```sql
-- 检查所有表数据量
SELECT 
  schemaname,
  tablename,
  n_tup_ins as "总插入",
  n_tup_upd as "总更新", 
  n_tup_del as "总删除"
FROM pg_stat_user_tables 
ORDER BY n_tup_ins DESC;

-- 检查最新投票记录
SELECT * FROM votes ORDER BY submitted_at DESC LIMIT 5;

-- 检查活动状态
SELECT id, name, status, start_time FROM events;
```

## ⚠️ 注意事项

1. **敏感信息**: 数据库备份包含完整数据，注意保密
2. **环境变量**: 确保新环境的 `.env` 配置正确
3. **端口冲突**: 检查新环境端口是否被占用
4. **权限问题**: 确保Docker有足够权限访问数据目录
5. **时区设置**: 数据库时间字段可能需要时区调整

## 📞 交接完成验证

新开发者启动系统后应该能看到:
- 3个活动事件
- 10位员工信息  
- 19个表演节目
- 4条投票记录
- 实时统计功能正常

如有问题，可对比数据计数进行排查。